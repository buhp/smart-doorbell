# ESPHome Configuration for Smart Doorbell with Deep Sleep
# ESP32-C6 DevKit Smart Doorbell System - Battery Optimized
# 
# This configuration provides:
# - Deep sleep mode for extended battery life (1-2 weeks with 500mAh)
# - Wake on button press (instant response)
# - Wake every 15 minutes to report battery status
# - Keep Awake mode for OTA updates and testing
# - All standard doorbell features

esphome:
  name: smart-doorbell
  friendly_name: Smart Doorbell
  comment: ESP32-C6 Smart Doorbell with Deep Sleep
  
  # On boot, check if we should stay awake or enter deep sleep
  on_boot:
    priority: -100
    then:
      - switch.turn_off: doorbell_ringer
      - logger.log: "Smart Doorbell System Started"
      # Log wakeup reason
      - lambda: |-
          ESP_LOGI("boot", "Wakeup cause: %d", esp_sleep_get_wakeup_cause());
          // 0=Reset, 2=GPIO (button), 4=Timer
      # If keep_awake is off, enter deep sleep after reporting
      - if:
          condition:
            switch.is_off: keep_awake_mode
          then:
            - delay: 30s  # Time to connect, report status, handle automations
            - deep_sleep.enter: deep_sleep_control

esp32:
  board: esp32-c6-devkitc-1
  variant: esp32c6
  framework:
    type: esp-idf

# Deep Sleep Configuration
# Optimized for battery life while maintaining responsiveness
deep_sleep:
  id: deep_sleep_control
  
  # Wake every 15 minutes to report battery status to Home Assistant
  # Adjust between 5min-60min based on your needs
  sleep_duration: 15min
  
  # Wake immediately when doorbell button is pressed
  wakeup_pin:
    number: GPIO4
    mode:
      input: true
      pullup: true
    inverted: true  # Wake when button pulls pin LOW
    wakeup_pin_mode: KEEP_AWAKE  # Don't sleep while button is held
  
  # How long to stay awake based on wakeup reason
  run_duration:
    default: 30s              # Timer wakeup: connect WiFi, report battery, sleep
    gpio_wakeup_reason: 60s   # Button press: ring bell, report to HA, sleep

# Enable logging
logger:
  level: INFO
  logs:
    deep_sleep: DEBUG  # See sleep/wake activity

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key
  services:
    # Service to ring doorbell from Home Assistant
    - service: ring_doorbell
      variables:
        duration: int
      then:
        - deep_sleep.prevent: deep_sleep_control  # Don't sleep while ringing
        - logger.log: 
            format: "Ringing doorbell for %d ms"
            args: [ 'duration' ]
        - switch.turn_on: doorbell_ringer
        - delay: !lambda "return duration;"
        - switch.turn_off: doorbell_ringer
        - if:
            condition:
              switch.is_off: keep_awake_mode
            then:
              - delay: 5s
              - deep_sleep.allow: deep_sleep_control
              - deep_sleep.enter: deep_sleep_control

# Enable OTA updates
ota:
  - platform: esphome
    password: !secret ota_password
    # Prevent deep sleep during OTA
    on_begin:
      - deep_sleep.prevent: deep_sleep_control
    on_end:
      - deep_sleep.allow: deep_sleep_control

# WiFi configuration
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  
  # Reduce WiFi power to save battery (optional)
  # output_power: 8.5dB  # Reduces range but saves ~20mA
  
  # Enable fallback hotspot
  ap:
    ssid: "Smart-Doorbell Fallback"
    password: !secret ap_password

# Fallback captive portal
captive_portal:

# Web server disabled for battery saving
# Enable temporarily by uncommenting for debugging
# web_server:
#   port: 80

# Status LED (optional - uses built-in LED if available)
status_led:
  pin:
    number: GPIO15
    inverted: false

# Binary Sensor - Doorbell Button
binary_sensor:
  # Doorbell button input
  - platform: gpio
    pin:
      number: GPIO4
      mode:
        input: true
        pullup: true
      inverted: true
    name: "Doorbell Button"
    id: doorbell_button
    device_class: occupancy
    
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    
    # When button pressed
    on_press:
      then:
        - logger.log: "Doorbell button pressed!"
        - deep_sleep.prevent: deep_sleep_control
        
        # Ring if auto-ring enabled
        - if:
            condition:
              switch.is_on: auto_ring_enabled
            then:
              - logger.log: "Auto-ring enabled, activating ringer"
              - switch.turn_on: doorbell_ringer
              - delay: 2s
              - switch.turn_off: doorbell_ringer
            else:
              - logger.log: "Auto-ring disabled, notification only"
        
        # Allow Home Assistant to receive notification
        - delay: 5s
        
        # Re-enter sleep if keep_awake is off
        - if:
            condition:
              switch.is_off: keep_awake_mode
            then:
              - deep_sleep.allow: deep_sleep_control
              - deep_sleep.enter: deep_sleep_control
    
    on_release:
      then:
        - logger.log: "Doorbell button released"

  # WiFi connection status
  - platform: status
    name: "Doorbell Status"
    id: doorbell_status

# Switch - Doorbell Ringer Control
switch:
  # Relay control for the ringer
  - platform: gpio
    pin: GPIO2
    name: "Doorbell Ringer"
    id: doorbell_ringer
    icon: "mdi:bell-ring"
    restore_mode: ALWAYS_OFF
    
    # Auto-off safety timer
    on_turn_on:
      - logger.log: "Ringer activated"
      - delay: 10s
      - switch.turn_off: doorbell_ringer
      - logger.log: "Ringer auto-off after 10s"
  
  # Enable/disable auto-ring
  - platform: template
    name: "Auto Ring Enabled"
    id: auto_ring_enabled
    icon: "mdi:bell-check"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    on_turn_on:
      - logger.log: "Auto-ring enabled"
    on_turn_off:
      - logger.log: "Auto-ring disabled (notification only)"
  
  # Keep Awake Mode - prevents deep sleep
  # Enable this before OTA updates or for debugging
  - platform: template
    name: "Keep Awake Mode"
    id: keep_awake_mode
    icon: "mdi:sleep-off"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF  # Default: allow sleep (save battery)
    on_turn_on:
      - logger.log: "Keep awake mode ON - deep sleep prevented"
      - deep_sleep.prevent: deep_sleep_control
    on_turn_off:
      - logger.log: "Keep awake mode OFF - entering deep sleep"
      - deep_sleep.allow: deep_sleep_control
      - delay: 30s  # Time to finish any pending operations
      - deep_sleep.enter: deep_sleep_control

# Sensors
sensor:
  # Wakeup cause - shows why device woke from sleep
  - platform: template
    name: "Wakeup Cause"
    id: wakeup_cause
    accuracy_decimals: 0
    icon: "mdi:sleep"
    lambda: |-
      int cause = esp_sleep_get_wakeup_cause();
      // 0=Reset, 2=GPIO, 4=Timer
      return cause;
    # Update only on boot
    update_interval: never
  
  # WiFi signal strength
  - platform: wifi_signal
    name: "Doorbell WiFi Signal"
    id: doorbell_wifi_signal
    update_interval: 60s
  
  # Uptime sensor
  - platform: uptime
    name: "Doorbell Uptime"
    id: doorbell_uptime
    update_interval: 60s
  
  # Battery voltage monitoring
  - platform: adc
    pin: GPIO5
    name: "Battery Voltage"
    id: battery_voltage
    update_interval: 30s
    attenuation: 11dB
    filters:
      - multiply: 2.0  # Voltage divider compensation
      - calibrate_linear:
          - 0.0 -> 0.0
          - 3.3 -> 3.3
      - sliding_window_moving_average:
          window_size: 10
          send_every: 5
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 2
  
  # Battery percentage
  - platform: template
    name: "Battery Level"
    id: battery_level
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    accuracy_decimals: 0
    icon: "mdi:battery"
    lambda: |-
      float voltage = id(battery_voltage).state;
      float min_voltage = 3.0;
      float max_voltage = 4.2;
      
      if (voltage < min_voltage) return 0.0;
      if (voltage > max_voltage) return 100.0;
      
      float percentage = ((voltage - min_voltage) / (max_voltage - min_voltage)) * 100.0;
      return percentage;
    update_interval: 30s
    
    # Dynamic battery icon
    on_value:
      then:
        - lambda: |-
            float level = id(battery_level).state;
            if (level > 90) {
              id(battery_level).set_icon("mdi:battery");
            } else if (level > 70) {
              id(battery_level).set_icon("mdi:battery-80");
            } else if (level > 50) {
              id(battery_level).set_icon("mdi:battery-60");
            } else if (level > 30) {
              id(battery_level).set_icon("mdi:battery-40");
            } else if (level > 10) {
              id(battery_level).set_icon("mdi:battery-20");
            } else {
              id(battery_level).set_icon("mdi:battery-alert");
            }
  
  # Doorbell press counter
  - platform: template
    name: "Doorbell Press Count"
    id: press_count
    icon: "mdi:counter"
    accuracy_decimals: 0
    state_class: total_increasing
    unit_of_measurement: "presses"
    lambda: |-
      static int count = 0;
      if (id(doorbell_button).state) {
        count++;
      }
      return count;
    update_interval: 1s

# Text sensors
text_sensor:
  # Device information
  - platform: wifi_info
    ip_address:
      name: "Doorbell IP Address"
    ssid:
      name: "Doorbell WiFi SSID"
  
  - platform: version
    name: "Doorbell ESPHome Version"
  
  # Wakeup reason as text
  - platform: template
    name: "Wakeup Reason"
    icon: "mdi:information-outline"
    lambda: |-
      int cause = esp_sleep_get_wakeup_cause();
      switch(cause) {
        case 0: return {"Power On / Reset"};
        case 2: return {"Button Pressed (GPIO)"};
        case 4: return {"Timer (Scheduled Wake)"};
        default: return {"Unknown: " + to_string(cause)};
      }
    update_interval: never

# Time component
time:
  - platform: homeassistant
    id: homeassistant_time

# Buttons
button:
  # Restart device
  - platform: restart
    name: "Doorbell Restart"
    icon: "mdi:restart"
  
  # Test ring
  - platform: template
    name: "Test Ring"
    icon: "mdi:bell-ring-outline"
    on_press:
      - deep_sleep.prevent: deep_sleep_control
      - logger.log: "Test ring activated"
      - switch.turn_on: doorbell_ringer
      - delay: 1s
      - switch.turn_off: doorbell_ringer
      - if:
          condition:
            switch.is_off: keep_awake_mode
          then:
            - delay: 5s
            - deep_sleep.allow: deep_sleep_control
            - deep_sleep.enter: deep_sleep_control

# Intervals for health monitoring
interval:
  # Low battery warning
  - interval: 30min
    then:
      - if:
          condition:
            lambda: 'return id(battery_level).state < 20.0;'
          then:
            - logger.log:
                level: WARN
                format: "Low battery: %.0f%% (%.2fV)"
                args:
                  - id(battery_level).state
                  - id(battery_voltage).state
